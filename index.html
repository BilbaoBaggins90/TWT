<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Torn War Room (Pure v2)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #121212; color: #e0e0e0; font-family: 'Inter', sans-serif; }
        .header-section { background: #1e1e1e; padding: 20px 0; border-bottom: 1px solid #333; margin-bottom: 30px; }
        .api-input { background: #2d2d2d; border: 1px solid #444; color: #fff; text-align: center; font-family: monospace; }
        .api-input:focus { background: #000; border-color: #7952b3; color: #fff; box-shadow: none; }
        .card-custom { background: #1e1e1e; border: 1px solid #333; border-radius: 12px; }
        .card-header-custom { background: #252525; border-bottom: 1px solid #333; padding: 15px 20px; font-weight: 600; }
        .chain-val { font-size: 3.5rem; font-weight: 800; line-height: 1; }
        .chain-time { font-size: 1.5rem; font-weight: 700; }
        .text-chain-cool { color: #20c997; } 
        .text-chain-warn { color: #ffc107; } 
        .text-chain-crit { color: #ff6b6b; } 
        .table-custom th { background-color: #252525; color: #888; text-transform: uppercase; font-size: 0.75rem; padding: 15px; }
        .table-custom td { vertical-align: middle; background-color: #1e1e1e; border-bottom: 1px solid #2a2a2a; padding: 15px; color: #ddd; }
        .status-badge { padding: 5px 10px; border-radius: 6px; font-size: 0.85rem; font-weight: 600; text-transform: uppercase; min-width: 80px; text-align: center; display:inline-block; }
        .st-okay { background: rgba(32, 201, 151, 0.15); color: #20c997; border: 1px solid rgba(32, 201, 151, 0.3); }
        .st-hosp { background: rgba(255, 107, 107, 0.15); color: #ff6b6b; border: 1px solid rgba(255, 107, 107, 0.3); }
        .st-jail { background: rgba(255, 193, 7, 0.15);   color: #ffc107; border: 1px solid rgba(255, 193, 7, 0.3); }
        .st-trav { background: rgba(13, 202, 240, 0.15);  color: #0dcaf0; border: 1px solid rgba(13, 202, 240, 0.3); }
        .lvl-easy { color: #20c997; font-weight: bold; } 
        .lvl-fair { color: #ffc107; font-weight: bold; } 
        .lvl-hard { color: #ff6b6b; font-weight: bold; } 
        .btn-attack { background-color: #ff6b6b; color: white; border: none; font-weight: bold; font-size: 0.8rem; padding: 6px 15px; }
        .btn-spy { background-color: #495057; color: white; border: none; font-weight: bold; font-size: 0.8rem; padding: 6px 10px; margin-right: 5px; }
    </style>
</head>
<body>

<div class="header-section">
    <div class="container">
        <div class="row align-items-center">
            <div class="col-md-6">
                <h3 class="fw-bold mb-0 text-white">‚öîÔ∏è War Room <span class="text-muted fs-6">Pure v2</span></h3>
            </div>
            <div class="col-md-6 mt-3 mt-md-0">
                <div class="input-group">
                    <input type="text" id="apiKey" class="form-control api-input" placeholder="Enter Public API Key">
                    <button class="btn btn-primary" onclick="initTool()">Load Profile</button>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="container">
    <div id="alertArea"></div>
    <div id="loading" class="text-center py-5" style="display:none;">
        <div class="spinner-border text-primary" role="status"></div>
        <p class="mt-3 text-muted">Talking to API v2...</p>
    </div>

    <div id="dashboard" style="display:none;">
        <div class="row g-4 mb-4">
            <div class="col-lg-5">
                <div class="card-custom h-100 p-4 text-center d-flex flex-column justify-content-center">
                    <div class="text-uppercase text-muted small mb-2">Chain Status</div>
                    <div id="chainCount" class="chain-val text-white">-</div>
                    <div id="chainTimeout" class="chain-time mt-2">-</div>
                </div>
            </div>
            <div class="col-lg-7">
                <div class="card-custom h-100">
                    <div class="card-header-custom">Target Settings</div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-8">
                                <label class="small text-muted mb-1">Enemy Faction (ID or URL)</label>
                                <div class="input-group">
                                    <input type="text" id="enemyId" class="form-control bg-dark text-white border-secondary" placeholder="Paste ID or Link...">
                                    <button class="btn btn-outline-light" onclick="autoDetectWar()">Auto-Detect</button>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <label class="small text-muted mb-1">Filter</label>
                                <select id="statusFilter" class="form-select bg-dark text-white border-secondary" onchange="fetchTargets()">
                                    <option value="okay" selected>Attackable</option>
                                    <option value="all">Show All</option>
                                </select>
                            </div>
                        </div>
                        <button class="btn btn-success w-100 mt-3 py-2 fw-bold" onclick="fetchTargets()">SCAN TARGETS</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="card-custom overflow-hidden">
            <div class="card-header-custom d-flex justify-content-between align-items-center">
                <span>Target List (My Level: <span id="myLevelDisplay" class="text-info fw-bold">--</span>)</span>
                <span id="targetCount" class="badge bg-secondary">0</span>
            </div>
            <div class="table-responsive">
                <table class="table table-custom w-100">
                    <thead>
                        <tr>
                            <th style="padding-left:25px;">Name</th>
                            <th>Level (Diff)</th>
                            <th>Est. Respect</th>
                            <th>Status</th>
                            <th class="text-end" style="padding-right:25px;">Action</th>
                        </tr>
                    </thead>
                    <tbody id="targetTable">
                        <tr><td colspan="5" class="text-center p-5 text-muted">Ready to scan.</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
    // === CONFIG ===
    const FALLBACK_ENEMY_ID = 0; 
    // ==============

    const getEl = (id) => document.getElementById(id);
    const showError = (msg) => {
        const area = getEl('alertArea');
        area.innerHTML = `<div class="alert alert-warning alert-dismissible fade show">${msg}<button type="button" class="btn-close" data-bs-dismiss="alert"></button></div>`;
    };

    document.addEventListener('DOMContentLoaded', () => {
        const savedKey = localStorage.getItem('torn_api_key');
        if(savedKey) getEl('apiKey').value = savedKey;
        if(FALLBACK_ENEMY_ID > 0) getEl('enemyId').value = FALLBACK_ENEMY_ID;

        // Populate Level from previous session if available
        const savedLvl = localStorage.getItem('my_level');
        if(savedLvl) getEl('myLevelDisplay').innerText = savedLvl;

        getEl('enemyId').addEventListener('input', (e) => {
            const val = e.target.value;
            const match = val.match(/ID=(\d+)/i) || val.match(/factions\/(\d+)/i);
            if(match) e.target.value = match[1];
        });
    });

    // --- PURE V2 API FETCHER ---
    async function apiV2(endpoint) {
        const key = getEl('apiKey').value.trim();
        // Uses strictly v2 endpoint structure
        const res = await fetch(`https://api.torn.com/v2/${endpoint}?key=${key}`);
        const data = await res.json();
        
        if(data.error) throw new Error(data.error.error || "Torn API Error");
        return data;
    }

    // --- MAIN ENGINE ---

    async function initTool() {
        const key = getEl('apiKey').value.trim();
        if(!key) return showError("Please enter API Key");
        localStorage.setItem('torn_api_key', key);
        
        getEl('dashboard').style.display = 'block';
        
        try { 
            await getMyProfile(); 
            updateChain(); 
            setInterval(updateChain, 30000); 
        } catch(e) { showError("Profile Load Failed: " + e.message); }

        if(getEl('enemyId').value.trim()) fetchTargets();
    }

    // 1. GET PROFILE (V2)
    async function getMyProfile() {
        const data = await apiV2('user/profile');
        if(data.faction) localStorage.setItem('my_faction_id', data.faction.faction_id);
        if(data.level) {
            localStorage.setItem('my_level', data.level);
            getEl('myLevelDisplay').innerText = data.level;
        }
    }

    // 2. DETECT WAR (V2)
    async function autoDetectWar() {
        const id = localStorage.getItem('my_faction_id');
        if(!id) return showError("Load profile first");
        
        getEl('loading').style.display = 'block';
        let enemyId = null;

        try {
            const data = await apiV2(`faction/${id}/wars`);
            
            // Handle V2 War Structure (Arrays vs Objects)
            const ranked = data.ranked_wars || {};
            for(let k in ranked) {
                const w = ranked[k];
                if(w.factions) {
                     for(let fid in w.factions) if(parseInt(fid) !== parseInt(id)) enemyId = fid;
                }
            }
            
            if(!enemyId && data.territory_wars) {
                data.territory_wars.forEach(w => {
                    if(w.assaulting_faction == id) enemyId = w.defending_faction;
                    if(w.defending_faction == id) enemyId = w.assaulting_faction;
                });
            }

            if(enemyId) {
                getEl('enemyId').value = enemyId;
                fetchTargets();
            } else {
                showError("No active war detected. Paste Enemy ID manually.");
            }
        } catch(e) { showError(e.message); }
        getEl('loading').style.display = 'none';
    }

    // 3. FETCH TARGETS (V2)
    async function fetchTargets() {
        const rawId = getEl('enemyId').value.trim();
        if(!rawId) return showError("Enter valid ID");
        
        getEl('loading').style.display = 'block';
        getEl('targetTable').innerHTML = '';
        
        // Ensure My Level is loaded. If not, fetch it now.
        let myLevel = parseInt(localStorage.getItem('my_level')) || 0;
        if(myLevel === 0) {
            try {
                await getMyProfile();
                myLevel = parseInt(localStorage.getItem('my_level')) || 0;
            } catch(e) {}
        }

        try {
            const data = await apiV2(`faction/${rawId}/members`);
            
            // V2 usually returns array, but safety check for object
            let members = Array.isArray(data.members) ? data.members : Object.values(data.members || {});
            members.sort((a,b) => b.level - a.level);
            
            const filter = getEl('statusFilter').value;
            let html = '';
            let count = 0;

            members.forEach(m => {
                const state = m.status.state;
                if(filter === 'okay' && state !== 'Okay') return;
                count++;

                let stClass = 'st-okay';
                if(state === 'Hospital') stClass = 'st-hosp';
                if(state === 'Jail') stClass = 'st-jail';
                if(state === 'Traveling') stClass = 'st-trav';

                const rMin = ((Math.log(m.level)+1)/4).toFixed(2);
                const rMax = (rMin*3).toFixed(2);

                // Level Difference Logic
                let diff = m.level - myLevel;
                let diffClass = 'text-muted'; 
                let diffText = 'Same';

                if(myLevel > 0) {
                    if (diff <= -10) { 
                        diffClass = 'lvl-easy'; 
                        diffText = `-${Math.abs(diff)} (Easy)`;
                    } else if (diff >= 10) { 
                        diffClass = 'lvl-hard'; 
                        diffText = `+${diff} (Hard)`;
                    } else { 
                        diffClass = 'lvl-fair'; 
                        diffText = (diff > 0 ? `+${diff}` : diff) + " (Fair)";
                    }
                }

                html += `
                <tr>
                    <td style="padding-left: 25px;">
                        <a href="https://www.torn.com/profiles.php?XID=${m.id}" target="_blank" class="text-white text-decoration-none fw-bold">${m.name}</a>
                        <span class="text-muted small ms-2">[${m.id}]</span>
                    </td>
                    <td>
                        <span class="badge bg-dark border border-secondary">${m.level}</span>
                        <div class="${diffClass} small" style="font-size:0.75rem;">${diffText}</div>
                    </td>
                    <td class="text-info font-monospace">${rMin} - ${rMax}</td>
                    <td><span class="status-badge ${stClass}">${state}</span></td>
                    <td class="text-end" style="padding-right: 25px;">
                        <a href="https://yata.yt/profile/${m.id}" target="_blank" class="btn btn-spy rounded-pill" title="Check Spies on YATA">üëÅÔ∏è Spy</a>
                        <a href="https://www.torn.com/loader.php?sid=attack&user2ID=${m.id}" target="_blank" class="btn btn-attack rounded-pill">ATTACK</a>
                    </td>
                </tr>`;
            });

            if(count===0) html = `<tr><td colspan="5" class="text-center p-5 text-muted">No targets found.</td></tr>`;
            getEl('targetTable').innerHTML = html;
            getEl('targetCount').innerText = count;

        } catch(e) { showError(e.message); }
        getEl('loading').style.display = 'none';
    }

    // 4. CHAIN UPDATE (V2)
    async function updateChain() {
        const id = localStorage.getItem('my_faction_id');
        if(!id) return;
        try {
            const data = await apiV2(`faction/${id}/chain`);
            const c = data.chain || {};
            getEl('chainCount').innerText = c.current || 0;
            
            const t = c.timeout || 0;
            const el = getEl('chainTimeout');
            el.innerText = t + 's';
            el.className = 'chain-time ' + (t < 30 ? 'text-chain-crit' : (t < 60 ? 'text-chain-warn' : 'text-chain-cool'));
        } catch {}
    }
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
