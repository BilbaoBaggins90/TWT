<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Torn War Room - Robust</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #121212; color: #ccc; font-family: monospace; }
        .box { background: #1e1e1e; border: 1px solid #333; border-radius: 8px; padding: 20px; margin-bottom: 20px; }
        .btn-primary { background-color: #0d6efd; border: none; font-weight: bold; }
        .log-window { background: #000; color: #0f0; height: 150px; overflow-y: scroll; padding: 10px; border: 1px solid #444; font-size: 12px; font-family: 'Courier New', monospace; margin-bottom: 20px; }
        .error-text { color: #ff5555; }
        .success-text { color: #55ff55; }
        
        /* Table */
        .table-dark th { background: #222; color: #888; }
        .table-dark td { background: #1a1a1a; vertical-align: middle; }
        
        /* Badges */
        .badge-status { padding: 4px 8px; border-radius: 4px; font-weight: bold; font-size: 0.8rem; }
        .b-okay { background: rgba(32, 201, 151, 0.2); color: #20c997; }
        .b-hosp { background: rgba(220, 53, 69, 0.2); color: #dc3545; }
        .b-jail { background: rgba(255, 193, 7, 0.2); color: #ffc107; }
        .b-trav { background: rgba(13, 202, 240, 0.2); color: #0dcaf0; }
    </style>
</head>
<body>

<div class="container mt-4">
    <h3 class="mb-4 text-white">⚔️ Torn War Room <small class="text-muted fs-6">(Robust Mode)</small></h3>

    <div class="box">
        <label class="form-label text-white">Step 1: API Connection</label>
        <div class="input-group">
            <input type="text" id="apiKey" class="form-control bg-dark text-white" placeholder="Enter Public Key">
            <button class="btn btn-primary" onclick="connectAPI()">TEST CONNECTION</button>
        </div>
    </div>

    <div id="sysLog" class="log-window">Waiting for input...</div>

    <div id="dashboard" style="display:none;">
        
        <div class="row mb-3">
            <div class="col-md-6">
                <div class="box h-100 text-center">
                    <div class="text-muted small">CHAIN</div>
                    <h2 id="chainCount" class="text-white">-</h2>
                    <div id="chainTimer">-</div>
                </div>
            </div>
            <div class="col-md-6">
                 <div class="box h-100 text-center">
                    <div class="text-muted small">MY STATUS</div>
                    <div id="myDetails" class="mt-2 text-info">Not Loaded</div>
                </div>
            </div>
        </div>

        <div class="box">
            <div class="row g-2">
                <div class="col-md-8">
                    <input type="text" id="enemyId" class="form-control bg-dark text-white" placeholder="Enemy Faction ID">
                </div>
                <div class="col-md-4">
                    <button class="btn btn-success w-100 fw-bold" onclick="scanEnemy()">SCAN TARGETS</button>
                </div>
            </div>
        </div>

        <div class="box p-0 overflow-hidden">
            <div class="table-responsive">
                <table class="table table-dark mb-0">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Level</th>
                            <th>Status</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="resultTable">
                        <tr><td colspan="4" class="text-center p-3 text-muted">Enter ID and click Scan</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

    </div>
</div>

<script>
    // --- LOGGER ---
    const LOG = document.getElementById('sysLog');
    function log(msg, type='info') {
        const color = type === 'error' ? 'error-text' : 'success-text';
        LOG.innerHTML += `<div><span class="${color}">></span> ${msg}</div>`;
        LOG.scrollTop = LOG.scrollHeight;
    }

    // --- GLOBAL STATE ---
    let myLevel = 0;
    let myFaction = null;

    // --- 1. CONNECT & TEST ---
    async function connectAPI() {
        const key = document.getElementById('apiKey').value.trim();
        if(!key) return log("Error: API Key is empty", "error");
        
        localStorage.setItem('torn_api_key', key);
        log("Testing connection...");

        try {
            // Use V2 for Profile Check
            const url = `https://api.torn.com/v2/user/profile?key=${key}`;
            const res = await fetch(url);
            const data = await res.json();

            if(data.error) {
                log(`API Error: ${data.error.error}`, "error");
                return;
            }

            log(`Connected! Welcome, ${data.name}`);
            
            // Save Data
            myLevel = data.level;
            myFaction = data.faction?.faction_id;
            
            // Update UI
            document.getElementById('dashboard').style.display = 'block';
            document.getElementById('myDetails').innerText = `Lvl ${myLevel} | Fac: ${myFaction || 'None'}`;
            
            // Start Chain Watcher
            if(myFaction) {
                log("Starting Chain Monitor...");
                updateChain();
                setInterval(updateChain, 30000);
            }

            // Try to Auto-Fill Enemy ID if we find a war
            detectWar();

        } catch(e) {
            log(`Network Error: ${e.message}`, "error");
            log("Check if your AdBlock is blocking 'api.torn.com'", "error");
        }
    }

    // --- 2. DETECT WAR (V2) ---
    async function detectWar() {
        if(!myFaction) return;
        const key = document.getElementById('apiKey').value;
        
        try {
            log("Checking for active wars...");
            const res = await fetch(`https://api.torn.com/v2/faction/${myFaction}/wars?key=${key}`);
            const data = await res.json();
            
            let enemyId = null;
            
            // Check Ranked
            const ranked = data.ranked_wars || {};
            for(let k in ranked) {
                const w = ranked[k];
                if(w.factions) {
                    for(let fid in w.factions) if(parseInt(fid) !== parseInt(myFaction)) enemyId = fid;
                }
            }

            if(enemyId) {
                document.getElementById('enemyId').value = enemyId;
                log(`Auto-Detected War with Faction ${enemyId}`);
            } else {
                log("No active war found via API. Please enter ID manually.");
            }

        } catch(e) { log("War detection skipped: " + e.message, "error"); }
    }

    // --- 3. SCAN ENEMY (V2) ---
    async function scanEnemy() {
        const enemyId = document.getElementById('enemyId').value.trim();
        if(!enemyId) return log("Error: Enter an Enemy ID", "error");
        
        const key = document.getElementById('apiKey').value;
        log(`Scanning Faction ${enemyId}...`);
        
        const tbody = document.getElementById('resultTable');
        tbody.innerHTML = '<tr><td colspan="4" class="text-center p-3">Scanning...</td></tr>';

        try {
            // Using V2 Members Endpoint
            const res = await fetch(`https://api.torn.com/v2/faction/${enemyId
